import { describe, it, expect, afterAll, beforeAll } from 'vitest';
import request from 'supertest';
import { init } from '../server.js';
import { Server } from 'http';
import jwt from 'jsonwebtoken';

describe("LTI CSRF Vulnerability Reproduction", () => {
    let server: Server;
    let ltiToken: string;
    let accessToken: string;

    beforeAll(async () => {
        // Start server on random port
        // process.env.NODE_ENV = 'test'; // vitest sets this usually
        process.env.JWT_SECRET = "test_secret";
        process.env.CSRF_SECRET = "test_csrf_secret";
        server = init(0);

        // Generate LTI token
        const ltiPayload = {
            sub: "lti_user_123",
            name: "LTI User",
            email: "lti@example.com",
            roles: ["student"]
        };
        ltiToken = jwt.sign(ltiPayload, process.env.JWT_SECRET);

        // Generate Access Token (for control)
        const accessPayload = {
            _id: "user_123",
            email: "user@example.com"
        };
        accessToken = jwt.sign(accessPayload, process.env.JWT_SECRET);
    });

    afterAll((done) => {
        server.close(done);
    });

    it("Control: Authenticated user with access_token should be BLOCKED (403) without CSRF token", async () => {
        const res = await request(server)
            .post("/api/v1/event/some-id/slot")
            .set("Cookie", [`access_token=${accessToken}`])
            .send({ start: new Date().toISOString() });

        expect(res.status).toBe(403);
    });

    it("Vulnerability Fix: LTI user with lti_token should be BLOCKED (403) without CSRF token", async () => {
        const res = await request(server)
            .post("/api/v1/event/some-id/slot")
            .set("Cookie", [`lti_token=${ltiToken}`])
            .send({ start: new Date().toISOString() });

        expect(res.status).toBe(403);
    });

    it("Happy Path: LTI user with lti_token AND valid CSRF token should SUCCEED", async () => {
        // 1. Get CSRF token (must include lti_token so it generates for this session)
        const csrfRes = await request(server)
            .get("/api/v1/csrf-token")
            .set("Cookie", [`lti_token=${ltiToken}`]);

        expect(csrfRes.status).toBe(200);
        const token = csrfRes.body.csrfToken;

        // Capture the CSRF cookie set by the server (x-csrf-token)
        const cookies = csrfRes.headers['set-cookie'];

        // 2. Use token in POST
        // We must send back the lti_token AND the new x-csrf-token cookie
        const cookieHeader = [...(cookies || []), `lti_token=${ltiToken}`];

        const res = await request(server)
            .post("/api/v1/event/some-id/slot")
            .set("Cookie", cookieHeader)
            .set("x-csrf-token", token)
            .send({ start: new Date().toISOString() });

        // Should pass CSRF check. might fail later (404/500/etc) but NOT 403
        expect(res.status).not.toBe(403);
    });
});
